<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>문서 작성기</title>
  <style>
    body {
      font-family: 'Malgun Gothic', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .main-container { display: flex; gap: 30px; width: 100%; max-width: 1200px; }
    .editor-container {
      display: flex; width: 700px; height: 85vh; min-width: 200px;
      min-height: 200px; resize: both; overflow: auto;
      border: 1px solid #ccc; background-color: white; border-radius: 4px;
    }
    #text-editor {
      width: 100%; height: 100%; padding: 15px;
      font-size: 15px; line-height: 1.6; box-sizing: border-box; outline: none;
    }
    #text-editor > * { text-indent: 1em; margin: 0; padding: 0; }
    .right-panel {
      width: 250px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px;
    }
    .controls-container, .recent-files-panel {
      padding: 20px; border: 1px solid #ddd;
      background-color: #ffffff; border-radius: 5px;
    }
    .control-group { margin-bottom: 25px; }
    .control-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
    .control-group .inline-controls { display: flex; gap: 10px; }
    .control-group select, .control-group input[type="number"] {
      width: 100%; padding: 8px; border: 1px solid #ccc;
      border-radius: 3px; box-sizing: border-box;
    }
    .control-group button {
      width: 100%; padding: 10px; border: 1px solid #ccc;
      background-color: #f0f0f0; cursor: pointer; font-weight: bold;
      border-radius: 3px; margin-bottom: 10px; transition: background-color 0.2s;
    }
    .control-group button:hover { background-color: #e0e0e0; }
    #file-input { display: none; }
    .char-count-container {
      padding: 15px; border: 1px solid red;
      border-radius: 3px; font-size: 0.9em;
    }
    .char-count-container p { margin: 5px 0; }
    .recent-files-panel label { font-weight: bold; margin-bottom: 10px; display: block; }
    #recent-files-list {
      list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto;
    }
    #recent-files-list li {
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; padding: 6px 4px; border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    #recent-files-list li:hover { background-color: #f5f5f5; }
    #recent-files-list li button {
      margin-left: 10px; border: none; background: transparent;
      color: #999; font-size: 0.9em; cursor: pointer;
    }
    #recent-files-list li button:hover { color: crimson; }
  </style>
</head>
<body>
<div class="main-container">
  <div class="editor-container" id="editor-wrapper">
    <div id="text-editor" contenteditable="true" spellcheck="false"></div>
  </div>
  <div class="right-panel">
    <div class="controls-container">
      <div class="control-group">
        <label>폰트 설정</label>
        <div class="inline-controls">
          <select id="font-select">
            <option value="Sans">Sans</option>
            <option value="Serif">Serif</option>
            <option value="Monospace">Monospace</option>
            <option value="Malgun Gothic">맑은 고딕</option>
            <option value="Gulim">굴림</option>
            <option value="Dotum">돋움</option>
          </select>
          <input type="number" id="font-size-input" value="15" min="1">
        </div>
      </div>
      <div class="control-group">
        <button id="save-btn">저장</button>
        <button id="load-btn">불러오기</button>
        <input type="file" id="file-input" accept=".txt">
        <button id="save-as-btn">새 이름으로 저장</button>
      </div>
      <div class="char-count-container">
        <p id="char-count-inc-space">공백포함: 0자</p>
        <p id="char-count-exc-space">공백미포함: 0자</p>
      </div>
    </div>
    <div class="recent-files-panel">
      <label>최근 파일</label>
      <ul id="recent-files-list"></ul>
    </div>
  </div>
</div>
<script>
  let fileHandle = null;
  let lastSavedText = '';

  async function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("FileHandlesDB", 1);
      request.onupgradeneeded = event => {
        const db = event.target.result;
        db.createObjectStore("handles", { keyPath: "name" });
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  async function saveFileHandle(name, handle) {
    const db = await openDB();
    const tx = db.transaction("handles", "readwrite");
    tx.objectStore("handles").put({ name, handle });
    return tx.complete;
  }

  async function getAllFileHandles() {
    const db = await openDB();
    const tx = db.transaction("handles", "readonly");
    return tx.objectStore("handles").getAll();
  }

  async function deleteFileHandle(name) {
    const db = await openDB();
    const tx = db.transaction("handles", "readwrite");
    tx.objectStore("handles").delete(name);
    return tx.complete;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const textEditor = document.getElementById('text-editor');
    const editorWrapper = document.getElementById('editor-wrapper');
    const fontSelect = document.getElementById('font-select');
    const fontSizeInput = document.getElementById('font-size-input');
    const saveBtn = document.getElementById('save-btn');
    const saveAsBtn = document.getElementById('save-as-btn');
    const loadBtn = document.getElementById('load-btn');
    const charCountIncSpace = document.getElementById('char-count-inc-space');
    const charCountExcSpace = document.getElementById('char-count-exc-space');

    function updateCharCount() {
      const text = textEditor.innerText;
      const countWithSpaces = text.replace(/\n/g, '').length;
      const countWithoutSpaces = text.replace(/\s/g, '').length;
      charCountIncSpace.textContent = `공백포함: ${countWithSpaces}자`;
      charCountExcSpace.textContent = `공백미포함: ${countWithoutSpaces}자`;
    }

    function getEditorText() {
      const lines = Array.from(textEditor.children).map(child => child.innerText.replace(/\r?\n/g, ''));
      return lines.join('\n');
    }

    function markSaved(text) {
      lastSavedText = text;
      saveBtn.style.backgroundColor = 'green';
      saveBtn.style.color = 'white';
      saveBtn.textContent = '저장 (저장됨)';
    }

    function checkForChanges() {
      const currentText = getEditorText();
      if (currentText !== lastSavedText) {
        saveBtn.style.backgroundColor = 'crimson';
        saveBtn.style.color = 'white';
        saveBtn.textContent = '저장 (변경됨)';
      } else {
        markSaved(currentText);
      }
    }

    async function writeToFile() {
      const text = getEditorText();
      const blob = new Blob([text], { type: 'text/plain' });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
      markSaved(text);
      await saveFileHandle(fileHandle.name || 'Unnamed', fileHandle);
      renderRecentFileHandles();
    }

    saveBtn.addEventListener('click', async () => {
      if (fileHandle) await writeToFile();
      else saveAsBtn.click();
    });

    saveAsBtn.addEventListener('click', async () => {
      try {
        fileHandle = await window.showSaveFilePicker({
          types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }]
        });
        await writeToFile();
      } catch (err) { console.error(err); }
    });

    loadBtn.addEventListener('click', async () => {
      try {
        [fileHandle] = await window.showOpenFilePicker({
          types: [{ accept: { 'text/plain': ['.txt'] } }]
        });
        const file = await fileHandle.getFile();
        const text = await file.text();
        loadTextToEditor(text);
        await saveFileHandle(file.name, fileHandle);
        renderRecentFileHandles();
      } catch (err) {
        console.error('불러오기 실패:', err);
      }
    });

    function loadTextToEditor(text) {
      const lines = text.split('\n');
      const html = lines.map(line => line.trim() === '' ? '<div><br></div>' : `<div>${line}</div>`).join('');
      textEditor.innerHTML = html;
      updateCharCount();
      markSaved(getEditorText());
    }

    async function renderRecentFileHandles() {
      const list = document.getElementById('recent-files-list');
      list.innerHTML = '';
      const files = await getAllFileHandles();
      files.forEach(entry => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = entry.name;
        span.style.flexGrow = '1';
        span.style.cursor = 'pointer';
        span.addEventListener('click', async () => {
          try {
            const file = await entry.handle.getFile();
            const text = await file.text();
            fileHandle = entry.handle;
            loadTextToEditor(text);
          } catch (e) {
            alert('파일 접근이 거부되었거나 존재하지 않습니다.');
            console.error(e);
          }
        });
        const del = document.createElement('button');
        del.textContent = '✕';
        del.onclick = async (e) => {
          e.stopPropagation();
          await deleteFileHandle(entry.name);
          renderRecentFileHandles();
        };
        li.appendChild(span);
        li.appendChild(del);
        list.appendChild(li);
      });
    }

    fontSelect.addEventListener('change', e => {
      textEditor.style.fontFamily = e.target.value;
      localStorage.setItem('editorFontFamily', e.target.value);
    });

    fontSizeInput.addEventListener('input', e => {
      textEditor.style.fontSize = `${e.target.value}px`;
      localStorage.setItem('editorFontSize', e.target.value);
    });

    const resizeObserver = new ResizeObserver(() => {
      const styles = window.getComputedStyle(editorWrapper);
      localStorage.setItem('editorWidth', styles.width);
      localStorage.setItem('editorHeight', styles.height);
    });
    resizeObserver.observe(editorWrapper);

    textEditor.addEventListener('input', () => {
      updateCharCount();
      checkForChanges();
    });

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        saveBtn.click();
      }
    });

    // 초기화
    textEditor.innerHTML = '<div><br></div>';
    updateCharCount();
    renderRecentFileHandles();
  });
</script>
</body>
</html>
